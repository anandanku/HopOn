<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HopOn</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

<style>
*{box-sizing:border-box}
html,body{margin:0;height:100%;font-family:Poppins,sans-serif}
#map{position:absolute;inset:0}

/* MENU (TOP RIGHT) */
.menu-btn{
  position:fixed;
  top:20px;
  right:20px;
  width:48px;
  height:48px;
  background:#ff6b35;
  color:white;
  font-size:22px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:4000;
}

/* SEARCH (UPPER MIDDLE) */
.search-container{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 120px);
  max-width:460px;
  z-index:2000;
}
.search-box,button{
  width:100%;
  height:52px;
  margin-bottom:10px;
  border-radius:12px;
  border:2px solid #ff6b35;
  padding:0 16px;
}
button{
  background:#ff6b35;
  color:white;
  font-weight:600;
}

/* AUTOSUGGEST */
.suggestions{
  background:white;
  border:2px solid #ff6b35;
  border-top:none;
  display:none;
  max-height:200px;
  overflow:auto;
}
.suggestions div{padding:14px;cursor:pointer}
.suggestions div:hover{background:#ffe5d9}

/* BUS MARKER */
.bus-marker{width:46px;height:46px;transform:translate(-50%,-50%)}

/* POPUP */
.route-popup{
  position:absolute;
  bottom:56px;
  left:-120px;
  background:#000;
  padding:14px;
  border-radius:12px;
  min-width:260px;
  color:white;
  display:none;
}
.speed-circle{
  width:54px;height:54px;border-radius:50%;
  border:3px solid #ff6b35;
  display:flex;align-items:center;justify-content:center;
  font-weight:700;margin:10px auto;
}
.route-list{
  display:grid;
  grid-template-columns:20px 1fr;
  row-gap:12px;
}
.route-dot{
  width:10px;height:10px;border-radius:50%;
  background:#ff6b35;margin-top:4px;
}

@media(max-width:768px){
  .search-container{top:80px;width:calc(100% - 32px)}
}
</style>
</head>

<body>
<div id="map"></div>

<div class="menu-btn">â˜°</div>

<div class="search-container">
  <input id="src" class="search-box" placeholder="Source">
  <div id="srcSug" class="suggestions"></div>

  <input id="dst" class="search-box" placeholder="Destination">
  <div id="dstSug" class="suggestions"></div>

  <button id="getBuses">Get Buses</button>
</div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script>
let map;
let busesUI = [];   // stores { marker, routeCoords, sourceId, speedCircle }

async function initMap(){
  const res = await fetch("/config");
  const cfg = await res.json();
  mapboxgl.accessToken = cfg.MAPBOX_TOKEN;

  map = new mapboxgl.Map({
    container:"map",
    style:"mapbox://styles/mapbox/dark-v11",
    center:[86.07,26.34],
    zoom:6
  });
}
initMap();

/* AUTOSUGGEST */
async function geo(q){
  const r = await fetch(`https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?country=IN&limit=5&access_token=${mapboxgl.accessToken}`);
  return (await r.json()).features;
}
function bind(input, box, obj){
  input.addEventListener("input", async ()=>{
    if(input.value.length < 3){ box.style.display="none"; return; }
    const results = await geo(input.value);
    box.innerHTML="";
    results.forEach(p=>{
      const d=document.createElement("div");
      d.textContent=p.place_name;
      d.onclick=()=>{
        input.value=p.place_name;
        obj.lat=p.center[1];
        obj.lng=p.center[0];
        box.style.display="none";
      };
      box.appendChild(d);
    });
    box.style.display="block";
  });
}
const source={}, dest={};
bind(src,srcSug,source);
bind(dst,dstSug,dest);

/* FIND CLOSEST POINT ON ROUTE */
function closestIndex(coords, lat, lng){
  let min=Infinity, idx=0;
  coords.forEach((c,i)=>{
    const d=(c[1]-lat)**2+(c[0]-lng)**2;
    if(d<min){min=d;idx=i;}
  });
  return idx;
}

/* GET BUSES */
getBuses.onclick = async ()=>{
  if(!source.lat || !dest.lat) return alert("Select from suggestions");

  busesUI.forEach(b=>{
    if(map.getLayer(b.layerId)){
      map.removeLayer(b.layerId);
      map.removeSource(b.sourceId);
    }
    b.marker.remove();
  });
  busesUI=[];

  const res = await fetch("/livebuses",{
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({source,destination:dest})
  });
  const data = await res.json();

  data.routes.forEach(async (bus, i)=>{
    const waypoints = bus.subRoute.coordinates.map(c=>c.join(",")).join(";");
    const dir = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${waypoints}?geometries=geojson&overview=full&access_token=${mapboxgl.accessToken}`);
    const geojson = (await dir.json()).routes[0].geometry;

    const sourceId = "route"+i;
    const layerId = "route-layer"+i;

    map.addSource(sourceId,{
      type:"geojson",
      data:{type:"Feature",geometry:geojson}
    });
    map.addLayer({
      id:layerId,
      type:"line",
      source:sourceId,
      paint:{
        "line-width":6,
        "line-color":["#ff6b35","#ff9f1c","#ff4040"][i]
      }
    });

    const el=document.createElement("div");
    el.className="bus-marker";
    el.innerHTML=`<svg viewBox="0 0 64 64"><rect x="6" y="8" rx="6" ry="6" width="52" height="36" fill="#ff6b35"/></svg>`;

    const popup=document.createElement("div");
    popup.className="route-popup";
    const speed=document.createElement("div");
    speed.className="speed-circle";
    speed.textContent="0 km/h";

    const list=document.createElement("div");
    list.className="route-list";
    bus.fullRoute.stops.forEach(s=>{
      list.innerHTML+=`<div class="route-dot"></div><div>${s}</div>`;
    });
    popup.append(speed,list);
    el.appendChild(popup);
    el.onclick=e=>{e.stopPropagation();popup.style.display="block"};
    document.body.onclick=()=>popup.style.display="none";

    const marker=new mapboxgl.Marker({element:el})
      .setLngLat(geojson.coordinates[0])
      .addTo(map);

    busesUI.push({
      marker,
      routeCoords: geojson.coordinates,
      sourceId,
      layerId,
      speedCircle: speed
    });
  });
};

/* LIVE UPDATE */
setInterval(async ()=>{
  if(!busesUI.length) return;
  const r=await fetch("/livebuses");
  const live=await r.json();

  busesUI.forEach((b,i)=>{
    const bus=live[i];
    if(!bus) return;

    b.marker.setLngLat([bus.lng,bus.lat]);

    if(bus.lastlat!=null){
      const d=Math.sqrt((bus.lat-bus.lastlat)**2+(bus.lng-bus.lastlng)**2);
      b.speedCircle.textContent=Math.round(d*360)+" km/h";
    }

    const idx=closestIndex(b.routeCoords,bus.lat,bus.lng);
    const remaining=b.routeCoords.slice(idx);

    map.getSource(b.sourceId).setData({
      type:"Feature",
      geometry:{type:"LineString",coordinates:remaining}
    });
  });
},10000);
</script>
</body>
</html>
