<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>HopOn</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<link href="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css" rel="stylesheet">

<style>
*{box-sizing:border-box}
html,body{
  margin:0;
  height:100%;
  font-family:Poppins,sans-serif;
}
#map{
  position:absolute;
  inset:0;
}

/* ================= SEARCH ================= */
.search-container{
  position:fixed;
  top:20px;
  left:50%;
  transform:translateX(-50%);
  width:calc(100% - 32px);
  max-width:460px;
  z-index:2000;
}
.search-box,button{
  width:100%;
  height:52px;
  margin-bottom:10px;
  border-radius:12px;
  border:2px solid #ff6b35;
  padding:0 16px;
  font-size:15px;
}
button{
  background:#ff6b35;
  color:white;
  font-weight:600;
  cursor:pointer;
}

/* ================= AUTOSUGGEST ================= */
.suggestions{
  background:white;
  border:2px solid #ff6b35;
  border-top:none;
  display:none;
  max-height:200px;
  overflow:auto;
}
.suggestions div{
  padding:14px;
  cursor:pointer;
}
.suggestions div:hover{
  background:#ffe5d9;
}

/* ================= MENU ================= */
.menu-btn{
  position:fixed;
  top:20px;
  left:20px;
  width:48px;
  height:48px;
  background:#ff6b35;
  color:white;
  font-size:22px;
  border-radius:10px;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
  z-index:3000;
}

/* ================= SIDEBAR ================= */
.sidebar{
  position:fixed;
  top:0;
  left:-260px;
  width:240px;
  max-width:80%;
  height:100%;
  background:#111;
  padding:20px;
  transition:.3s ease;
  z-index:3100;
}
.sidebar.active{left:0}

/* ================= OVERLAY ================= */
.overlay{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,.6);
  display:none;
  z-index:3050;
}
.overlay.active{display:block}

/* ================= TOGGLE ================= */
.toggle{
  display:flex;
  justify-content:space-between;
  align-items:center;
  color:white;
  margin-top:20px;
}
.switch{
  position:relative;
  width:50px;
  height:26px;
}
.switch input{display:none}
.slider{
  position:absolute;
  inset:0;
  background:#777;
  border-radius:26px;
}
.slider:before{
  content:"";
  position:absolute;
  width:20px;
  height:20px;
  left:3px;
  top:3px;
  background:white;
  border-radius:50%;
  transition:.3s;
}
input:checked + .slider{
  background:#ff6b35;
}
input:checked + .slider:before{
  transform:translateX(24px);
}

/* ================= BUS MARKER ================= */
.bus-marker{
  width:46px;
  height:46px;
  transform:translate(-50%,-50%);
  cursor:pointer;
}

/* ================= ROUTE POPUP ================= */
.route-popup{
  position:absolute;
  bottom:56px;
  left:-120px;
  background:#000;
  padding:14px;
  border-radius:12px;
  min-width:260px;
  color:white;
  display:none;
}

/* ================= SPEED ================= */
.speed-circle{
  width:54px;
  height:54px;
  border-radius:50%;
  border:3px solid #ff6b35;
  display:flex;
  align-items:center;
  justify-content:center;
  font-weight:700;
  margin:10px auto;
}

/* ================= ROUTE LIST ================= */
.route-list{
  position:relative;
  display:grid;
  grid-template-columns:20px 1fr;
  row-gap:12px;
}
.route-line{
  position:absolute;
  left:9px;
  top:0;
  bottom:0;
  width:2px;
  background:white;
}
.route-dot{
  width:10px;
  height:10px;
  border-radius:50%;
  margin-top:4px;
  justify-self:center;
}

/* ================= MOBILE FIXES ================= */
@media (max-width: 768px){
  .search-container{
    top:70px;
  }

  .menu-btn{
    width:42px;
    height:42px;
    font-size:20px;
  }

  .route-popup{
    left:-90px;
    min-width:220px;
  }
}
</style>
</head>

<body>

<div id="map"></div>

<div class="menu-btn" id="menuBtn">â˜°</div>

<div class="search-container">
  <input id="src" class="search-box" placeholder="Source">
  <div id="srcSug" class="suggestions"></div>

  <input id="dst" class="search-box" placeholder="Destination">
  <div id="dstSug" class="suggestions"></div>

  <button id="getBuses">Get Buses</button>
</div>

<div class="sidebar" id="sidebar">
  <h3 style="color:#ff6b35">Menu</h3>

  <div class="toggle">
    <span>On Route</span>
    <label class="switch">
      <input type="checkbox" id="onRoute">
      <span class="slider"></span>
    </label>
  </div>

  <a href="/home/bus/register"
     style="display:block;margin-top:20px;background:#ff6b35;padding:12px;
     color:white;text-align:center;border-radius:10px;text-decoration:none">
    Register Bus
  </a>
</div>

<div class="overlay" id="overlay"></div>

<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>

<script>
let map;
let liveMarker = null;
let routeCoords = [];
let speedCircle = null;

let source = {};
let dest = {};

async function initMap() {
  const res = await fetch("/config");
  const cfg = await res.json();

  mapboxgl.accessToken = cfg.MAPBOX_TOKEN;

  map = new mapboxgl.Map({
    container: "map",
    style: "mapbox://styles/mapbox/dark-v11",
    center: [86.07, 26.34],
    zoom: 6
  });

  window.addEventListener("resize", () => map.resize());
}
initMap();

/* MENU */
menuBtn.onclick = () => {
  sidebar.classList.add("active");
  overlay.classList.add("active");
};
overlay.onclick = () => {
  sidebar.classList.remove("active");
  overlay.classList.remove("active");
};

/* AUTOSUGGEST */
async function geo(q){
  const r = await fetch(
    `https://api.mapbox.com/geocoding/v5/mapbox.places/${encodeURIComponent(q)}.json?country=IN&limit=5&access_token=${mapboxgl.accessToken}`
  );
  return (await r.json()).features;
}

function bind(input, box, obj){
  input.addEventListener("input", async () => {
    if(input.value.length < 3){
      box.style.display = "none";
      return;
    }
    const results = await geo(input.value);
    box.innerHTML = "";

    results.forEach(p => {
      const div = document.createElement("div");
      div.textContent = p.place_name;
      div.onclick = () => {
        input.value = p.place_name;
        obj.lat = p.center[1];
        obj.lng = p.center[0];
        box.style.display = "none";
      };
      box.appendChild(div);
    });

    box.style.display = "block";
  });
}

bind(src, srcSug, source);
bind(dst, dstSug, dest);
</script>

</body>
</html>
